name: Invite Users, Close Issues, and Post Message

on:
  workflow_dispatch:  # Allows manual trigger

jobs:
  invite_and_manage_issues:
    runs-on: ubuntu-latest

    steps:
      - name: Close all open issues
        env:
          GITHUB_TOKEN: ${{ secrets.INVITE_TOKEN }}
        run: |
          issues=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/issues?state=open" | jq -r '.[].number')

          for issue in $issues; do
            curl -X PATCH -H "Authorization: Bearer $GITHUB_TOKEN" \
              -d '{"state": "closed"}' \
              "https://api.github.com/repos/${{ github.repository }}/issues/$issue"
            echo "Closed issue #$issue"
          done

      - name: Invite users to GitHub organization
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ORG_NAME: "jaidevstudio"
        run: |
          issues=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/issues?state=open&labels=invite+me+to+the+organisation")

          for username in $(echo "$issues" | jq -r '.[].user.login'); do
            curl -X PUT -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              -d "{\"role\": \"direct_member\"}" \
              "https://api.github.com/orgs/$ORG_NAME/memberships/$username"
            echo "Invited $username to $ORG_NAME"
          done

      - name: Post message on issues
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          issues=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/issues?state=open&labels=invite+me+to+the+organisation" | jq -r '.[].number')

          for issue in $issues; do
            curl -X POST -H "Authorization: Bearer $GITHUB_TOKEN" \
              -d '{"body": "Your invitation has been sent! ðŸŽ‰ Please accept it and set it to public in your profile. The issue is now closed. See you in the community! ðŸ˜Š"}' \
              "https://api.github.com/repos/${{ github.repository }}/issues/$issue/comments"
            echo "Posted message on issue #$issue"
          done
